<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ”§ CAD Companion - Interface Completa</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .status {
        padding: 20px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .status.connected {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        border: 2px solid #28a745;
        color: #155724;
      }
      .status.disconnected {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        border: 2px solid #dc3545;
        color: #721c24;
      }
      .status.checking {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border: 2px solid #ffc107;
        color: #856404;
      }
      button {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        margin: 6px 4px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
      }
      button:active {
        transform: translateY(0);
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .btn-success {
        background: linear-gradient(135deg, #28a745, #218838);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
      }
      .btn-warning {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
      }
      .btn-danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
      }
      .file-input {
        width: 100%;
        padding: 14px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        margin: 12px 0;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      .file-input:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }
      .result {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
        white-space: pre-wrap;
        font-family: "Fira Code", "Courier New", monospace;
        font-size: 13px;
        max-height: 500px;
        overflow-y: auto;
        line-height: 1.5;
      }
      .result.loading {
        border-color: #007bff;
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        color: #1565c0;
        text-align: center;
        padding: 40px;
      }
      .result.success {
        border-color: #28a745;
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
      }
      .result.error {
        border-color: #dc3545;
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
      }
      .info {
        background: linear-gradient(135deg, #d1ecf1, #bee5eb);
        border-left: 4px solid #17a2b8;
        color: #0c5460;
        padding: 15px 20px;
        border-radius: 0 8px 8px 0;
        margin: 15px 0;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .assembly-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 8px 0;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .assembly-item:hover {
        background: #e9ecef;
        border-color: #007bff;
        transform: translateX(5px);
      }
      .assembly-item.active {
        background: #d4edda;
        border-color: #28a745;
      }
      .assembly-name {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
      }
      .assembly-path {
        font-size: 12px;
        color: #6c757d;
        font-family: monospace;
      }
      .assembly-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        margin-top: 8px;
      }
      .assembly-status.active {
        background: #28a745;
        color: white;
      }
      .assembly-status.inactive {
        background: #6c757d;
        color: white;
      }
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      h1 {
        color: white;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        margin-bottom: 30px;
        font-size: 2.5em;
      }
      h2 {
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .tab-container {
        display: flex;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
      }
      .tab {
        padding: 12px 20px;
        cursor: pointer;
        border-radius: 8px 8px 0 0;
        margin-right: 2px;
        transition: all 0.3s ease;
      }
      .tab.active {
        background: white;
        border-bottom: 2px solid #007bff;
      }
      .tab:hover {
        background: #e9ecef;
      }
      .tab-content {
        background: white;
        border-radius: 0 8px 8px 8px;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”§ CAD Companion - Interface Completa</h1>

    <!-- Status Section -->
    <div class="container">
      <h2>ğŸ“Š Status do Sistema</h2>
      <div id="status" class="status checking">
        <div class="loading-spinner"></div>
        ğŸ”„ Verificando conexÃ£o...
      </div>
      <button onclick="checkStatus()">ğŸ”„ Atualizar Status</button>
      <button onclick="reconnect()" class="btn-success">
        ğŸ”Œ Reconectar Inventor
      </button>
      <button onclick="getActiveDocument()" class="btn-warning">
        ğŸ“„ Documento Ativo
      </button>
    </div>

    <!-- Main Functionality Tabs -->
    <div class="container">
      <div class="tab-container">
        <div class="tab active" onclick="switchTab('extract')">
          ğŸ“‹ Extrair BOM
        </div>
        <div class="tab" onclick="switchTab('assemblies')">
          ğŸ“‚ Assemblies Abertos
        </div>
        <div class="tab" onclick="switchTab('files')">
          ğŸ“ Gerenciar Arquivos
        </div>
      </div>

      <!-- Extract BOM Tab -->
      <div id="tab-extract" class="tab-content">
        <h3>ğŸ“‹ Extrair BOM de Arquivo</h3>
        <div class="info">
          <strong>ğŸ’¡ Dica:</strong> Use um arquivo .iam (assembly) existente no
          seu computador
        </div>

        <label
          for="filePath"
          style="font-weight: bold; display: block; margin-bottom: 5px"
        >
          ğŸ“ Caminho do arquivo:
        </label>
        <input
          type="text"
          id="filePath"
          class="file-input"
          placeholder="Exemplo: C:\Users\kiera\Documents\Inventor\MeuProjeto\assembly.iam"
          value=""
        />

        <button onclick="extractBOM()">ğŸ” Extrair BOM</button>
        <button onclick="clearResult('bomResult')">ğŸ—‘ï¸ Limpar</button>

        <div id="bomResult" class="result" style="display: none"></div>
      </div>

      <!-- Open Assemblies Tab -->
      <div id="tab-assemblies" class="tab-content" style="display: none">
        <h3>ğŸ“‚ Assemblies Abertos no Inventor</h3>
        <button onclick="listOpenAssemblies()">ğŸ”„ Atualizar Lista</button>
        <button
          onclick="extractFromSelected()"
          class="btn-success"
          id="extractFromSelectedBtn"
          disabled
        >
          ğŸ” Extrair BOM do Selecionado
        </button>

        <div id="assembliesList" class="result" style="display: none"></div>
        <div
          id="selectedAssembly"
          style="margin: 15px 0; font-weight: bold; color: #007bff"
        ></div>
        <div id="bomFromOpen" class="result" style="display: none"></div>
      </div>

      <!-- File Management Tab -->
      <div id="tab-files" class="tab-content" style="display: none">
        <div class="grid">
          <div>
            <h3>ğŸ“‚ Abrir Arquivo no Inventor</h3>
            <label
              for="openFilePath"
              style="font-weight: bold; display: block; margin-bottom: 5px"
            >
              ğŸ“ Caminho do arquivo:
            </label>
            <input
              type="text"
              id="openFilePath"
              class="file-input"
              placeholder="Exemplo: C:\Users\kiera\Documents\Inventor\parte.ipt"
              value=""
            />

            <button onclick="openFile()">ğŸ“‚ Abrir Arquivo</button>
            <button onclick="clearResult('openResult')">ğŸ—‘ï¸ Limpar</button>

            <div id="openResult" class="result" style="display: none"></div>
          </div>

          <div>
            <h3>ğŸ¯ Ativar Documento</h3>
            <label
              for="activateFileName"
              style="font-weight: bold; display: block; margin-bottom: 5px"
            >
              ğŸ“„ Nome do arquivo:
            </label>
            <input
              type="text"
              id="activateFileName"
              class="file-input"
              placeholder="Exemplo: motor.iam"
              value=""
            />

            <button onclick="activateDocument()">ğŸ¯ Ativar</button>
            <button onclick="clearResult('activateResult')">ğŸ—‘ï¸ Limpar</button>

            <div id="activateResult" class="result" style="display: none"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:5000/api/bom";
      let selectedAssemblyName = null;

      // Verificar status automaticamente ao carregar
      window.onload = () => {
        console.log("ğŸš€ Interface completa carregada");
        console.log("ğŸ”Œ Companion esperado em:", API_BASE);
        checkStatus();
        listOpenAssemblies();
      };

      // ===== TAB MANAGEMENT =====
      function switchTab(tabName) {
        // Hide all tabs
        document.getElementById("tab-extract").style.display = "none";
        document.getElementById("tab-assemblies").style.display = "none";
        document.getElementById("tab-files").style.display = "none";

        // Remove active class from all tabs
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));

        // Show selected tab
        document.getElementById(`tab-${tabName}`).style.display = "block";

        // Add active class to clicked tab
        event.target.classList.add("active");

        // Load data for specific tabs
        if (tabName === "assemblies") {
          listOpenAssemblies();
        }
      }

      // ===== API COMMUNICATION =====
      async function makeRequest(endpoint, options = {}) {
        try {
          console.log(`ğŸ“¡ Request: ${API_BASE}${endpoint}`, options);

          const response = await fetch(`${API_BASE}${endpoint}`, {
            headers: {
              "Content-Type": "application/json",
              ...options.headers,
            },
            ...options,
          });

          const data = await response.json();
          console.log(`âœ… Response ${response.status}:`, data);

          return {
            success: response.ok,
            data,
            status: response.status,
          };
        } catch (error) {
          console.error("âŒ Request failed:", error);
          return {
            success: false,
            error: error.message,
            status: 0,
          };
        }
      }

      // ===== STATUS FUNCTIONS =====
      async function checkStatus() {
        const statusElement = document.getElementById("status");
        statusElement.innerHTML =
          '<div class="loading-spinner"></div> ğŸ”„ Verificando conexÃ£o...';
        statusElement.className = "status checking";

        const result = await makeRequest("/status");

        if (result.success && result.data) {
          const { inventorRunning, inventorVersion, companionId, timestamp } =
            result.data;

          if (inventorRunning) {
            statusElement.className = "status connected";
            statusElement.innerHTML = `
                        âœ… <strong>INVENTOR CONECTADO</strong><br>
                        ğŸ”§ VersÃ£o: ${inventorVersion}<br>
                        ğŸ’» Companion: ${companionId}<br>
                        â° Verificado: ${new Date(timestamp).toLocaleString()}
                    `;
          } else {
            statusElement.className = "status disconnected";
            statusElement.innerHTML = `
                        âŒ <strong>INVENTOR DESCONECTADO</strong><br>
                        ${result.data.error || "Inventor nÃ£o estÃ¡ rodando"}<br>
                        â° Verificado: ${new Date(timestamp).toLocaleString()}
                    `;
          }
        } else {
          statusElement.className = "status disconnected";
          statusElement.innerHTML = `
                    âŒ <strong>COMPANION INACESSÃVEL</strong><br>
                    Erro: ${result.error || "NÃ£o foi possÃ­vel conectar"}<br>
                    Status HTTP: ${result.status}
                `;
        }
      }

      async function reconnect() {
        const result = await makeRequest("/reconnect", { method: "POST" });

        if (result.success) {
          alert("âœ… ReconexÃ£o realizada com sucesso!");
          await checkStatus();
          await listOpenAssemblies();
        } else {
          alert(`âŒ Erro na reconexÃ£o: ${result.error}`);
        }
      }

      async function getActiveDocument() {
        const result = await makeRequest("/active-document");

        if (result.success && result.data) {
          if (result.data.hasActiveDocument) {
            const doc = result.data.activeDocument;
            alert(
              `ğŸ“„ Documento Ativo:\n\n` +
                `Nome: ${doc.fileName}\n` +
                `Tipo: ${doc.documentType}\n` +
                `Salvo: ${doc.isSaved ? "Sim" : "NÃ£o"}\n` +
                `Assembly: ${doc.isAssembly ? "Sim" : "NÃ£o"}`
            );
          } else {
            alert("ğŸ“­ Nenhum documento ativo no Inventor");
          }
        } else {
          alert(`âŒ Erro: ${result.error}`);
        }
      }

      // ===== BOM EXTRACTION =====
      async function extractBOM() {
        const filePath = document.getElementById("filePath").value.trim();
        const element = document.getElementById("bomResult");

        if (!filePath) {
          alert("âš ï¸ Digite o caminho do arquivo");
          return;
        }

        showResult(element, "ğŸ”„ Extraindo BOM, aguarde...", "loading");
        console.log("ğŸ” Iniciando extraÃ§Ã£o BOM para:", filePath);

        const result = await makeRequest("/extract", {
          method: "POST",
          body: JSON.stringify({ filePath }),
        });

        console.log("ğŸ“‹ Resultado extraÃ§Ã£o:", result);

        if (result.success && result.data) {
          const { bomData, totalItems, fileName, extractedAt } = result.data;
          displayBOMResults(
            element,
            bomData,
            totalItems,
            fileName,
            extractedAt
          );
          element.className = "result success";
        } else {
          showResult(
            element,
            `âŒ ERRO AO EXTRAIR BOM\n\n${
              result.error || "Erro desconhecido"
            }\n\nğŸ” Debug Info:\nStatus: ${
              result.status
            }\n\nVerifique se:\nâ€¢ O arquivo existe\nâ€¢ Ã‰ um arquivo .iam (assembly)\nâ€¢ O Inventor estÃ¡ conectado`,
            "error"
          );
        }
      }

      // ===== OPEN ASSEMBLIES =====
      async function listOpenAssemblies() {
        const element = document.getElementById("assembliesList");
        showResult(element, "ğŸ”„ Carregando assemblies abertos...", "loading");

        const result = await makeRequest("/open-assemblies");

        if (result.success && result.data) {
          const { assemblies, totalCount } = result.data;

          if (totalCount === 0) {
            showResult(
              element,
              "ğŸ“­ Nenhum assembly aberto no Inventor\n\nAbra um arquivo .iam no Inventor e atualize a lista.",
              "error"
            );
          } else {
            displayAssembliesList(element, assemblies);
            element.className = "result";
          }
        } else {
          showResult(
            element,
            `âŒ Erro ao listar assemblies: ${result.error}`,
            "error"
          );
        }
      }

      function displayAssembliesList(element, assemblies) {
        element.innerHTML = "";
        element.style.display = "block";

        assemblies.forEach((assembly) => {
          const assemblyDiv = document.createElement("div");
          assemblyDiv.className = `assembly-item ${
            assembly.isActive ? "active" : ""
          }`;
          assemblyDiv.onclick = () =>
            selectAssembly(assembly.fileName, assemblyDiv);

          assemblyDiv.innerHTML = `
                    <div class="assembly-name">${assembly.fileName}</div>
                    <div class="assembly-path">${assembly.filePath}</div>
                    <span class="assembly-status ${
                      assembly.isActive ? "active" : "inactive"
                    }">
                        ${assembly.isActive ? "ğŸŸ¢ Ativo" : "âšª Inativo"}
                    </span>
                    <span class="assembly-status ${
                      assembly.isSaved ? "active" : "inactive"
                    }">
                        ${assembly.isSaved ? "ğŸ’¾ Salvo" : "ğŸ“ Modificado"}
                    </span>
                `;

          element.appendChild(assemblyDiv);
        });
      }

      function selectAssembly(fileName, element) {
        // Remove selection from all items
        document.querySelectorAll(".assembly-item").forEach((item) => {
          item.style.borderColor = "#dee2e6";
          item.style.background = "#f8f9fa";
        });

        // Select clicked item
        element.style.borderColor = "#007bff";
        element.style.background = "#e3f2fd";

        selectedAssemblyName = fileName;
        document.getElementById(
          "selectedAssembly"
        ).textContent = `ğŸ“‹ Selecionado: ${fileName}`;
        document.getElementById("extractFromSelectedBtn").disabled = false;
      }

      async function extractFromSelected() {
        if (!selectedAssemblyName) {
          alert("âš ï¸ Selecione um assembly primeiro");
          return;
        }

        const element = document.getElementById("bomFromOpen");
        showResult(
          element,
          `ğŸ”„ Extraindo BOM de ${selectedAssemblyName}...`,
          "loading"
        );

        const result = await makeRequest("/extract-from-open", {
          method: "POST",
          body: JSON.stringify({ fileName: selectedAssemblyName }),
        });

        if (result.success && result.data) {
          const { bomData, totalItems, fileName, extractedAt } = result.data;
          displayBOMResults(
            element,
            bomData,
            totalItems,
            fileName,
            extractedAt
          );
          element.className = "result success";
        } else {
          showResult(
            element,
            `âŒ Erro ao extrair BOM: ${result.error}`,
            "error"
          );
        }
      }

      // ===== FILE MANAGEMENT =====
      async function openFile() {
        const filePath = document.getElementById("openFilePath").value.trim();
        const element = document.getElementById("openResult");

        if (!filePath) {
          alert("âš ï¸ Digite o caminho do arquivo");
          return;
        }

        showResult(element, "ğŸ”„ Abrindo arquivo no Inventor...", "loading");

        const result = await makeRequest("/open-file", {
          method: "POST",
          body: JSON.stringify({ filePath }),
        });

        if (result.success && result.data) {
          showResult(
            element,
            `âœ… ${result.data.message}\n\nğŸ“ Arquivo: ${
              result.data.filePath
            }\nâ° Aberto em: ${new Date(
              result.data.timestamp
            ).toLocaleString()}`,
            "success"
          );
          // Refresh assemblies list
          await listOpenAssemblies();
        } else {
          showResult(element, `âŒ Erro: ${result.error}`, "error");
        }
      }

      async function activateDocument() {
        const fileName = document
          .getElementById("activateFileName")
          .value.trim();
        const element = document.getElementById("activateResult");

        if (!fileName) {
          alert("âš ï¸ Digite o nome do arquivo");
          return;
        }

        showResult(element, "ğŸ¯ Ativando documento...", "loading");

        const result = await makeRequest("/activate-document", {
          method: "POST",
          body: JSON.stringify({ fileName }),
        });

        if (result.success && result.data) {
          showResult(
            element,
            `âœ… ${result.data.message}\nâ° Ativado em: ${new Date(
              result.data.timestamp
            ).toLocaleString()}`,
            "success"
          );
          await getActiveDocument();
        } else {
          showResult(element, `âŒ Erro: ${result.error}`, "error");
        }
      }

      // ===== UTILITY FUNCTIONS =====
      function showResult(element, text, className) {
        element.style.display = "block";
        element.textContent = text;
        element.className = `result ${className}`;
      }

      function clearResult(elementId) {
        const element = document.getElementById(elementId);
        element.style.display = "none";
        element.textContent = "";
        element.className = "result";
      }

      function displayBOMResults(
        element,
        bomData,
        totalItems,
        fileName,
        extractedAt
      ) {
        let text = `âœ… BOM EXTRAÃDA COM SUCESSO!\n\n`;
        text += `ğŸ“„ Arquivo: ${fileName}\n`;
        text += `ğŸ“Š Total de itens: ${totalItems}\n`;
        text += `â° ExtraÃ­do em: ${new Date(extractedAt).toLocaleString()}\n`;
        text += `\n${"=".repeat(60)}\n`;
        text += `ğŸ“‹ LISTA DE MATERIAIS:\n`;
        text += `${"=".repeat(60)}\n\n`;

        if (bomData && bomData.length > 0) {
          bomData.forEach((item, index) => {
            text += `${(index + 1).toString().padStart(3, " ")}. ${
              item.partNumber || "N/A"
            }\n`;
            text += `     ğŸ“ ${item.description || "Sem descriÃ§Ã£o"}\n`;
            text += `     ğŸ“¦ Quantidade: ${item.quantity || 0} ${
              item.unit || "UN"
            }\n`;

            if (item.material) {
              text += `     ğŸ”§ Material: ${item.material}\n`;
            }

            if (item.mass && item.mass > 0) {
              text += `     âš–ï¸ Massa: ${item.mass.toFixed(3)} kg\n`;
            }

            text += `     ğŸ“ NÃ­vel: ${item.level || 0}\n`;

            if (item.filePath) {
              text += `     ğŸ“ Arquivo: ${item.filePath.split("\\").pop()}\n`;
            }

            text += `\n`;
          });

          // EstatÃ­sticas
          text += `${"=".repeat(60)}\n`;
          text += `ğŸ“Š ESTATÃSTICAS:\n`;
          text += `${"=".repeat(60)}\n`;

          const totalMass = bomData.reduce(
            (sum, item) => sum + (item.mass || 0),
            0
          );
          const uniqueMaterials = [
            ...new Set(bomData.map((item) => item.material).filter(Boolean)),
          ];

          text += `âš–ï¸ Massa total: ${totalMass.toFixed(3)} kg\n`;
          text += `ğŸ”§ Materiais Ãºnicos: ${uniqueMaterials.length}\n`;

          if (uniqueMaterials.length > 0) {
            text += `\nğŸ”§ Materiais encontrados:\n`;
            uniqueMaterials.forEach((material) => {
              text += `   â€¢ ${material}\n`;
            });
          }
        } else {
          text += `âš ï¸ Nenhum item encontrado na BOM\n`;
        }

        element.textContent = text;
        element.style.display = "block";
      }

      // Auto-refresh status e assemblies a cada 30 segundos
      setInterval(() => {
        checkStatus();
        if (
          document.getElementById("tab-assemblies").style.display !== "none"
        ) {
          listOpenAssemblies();
        }
      }, 30000);
    </script>
  </body>
</html>
